YUI.add("moodle-atto_blockquote-button",function(e,t){e.namespace("M.atto_blockquote").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,initializer:function(){this.addButton({icon:"e/cite",title:"quote",callback:this._addBlockQuote}),this._setupKeyListener()},_addBlockQuote:function(){var t=this.get("host");this._currentSelection=t.getSelection();if(this._currentSelection===!1)return;var n=this._currentSelection[0].startContainer,r=this._currentSelection[0].startOffset,i=e.one(this._currentSelection[0].startContainer),s=e.one(this._currentSelection[0].endContainer),o=i.ancestor("p");o&&t.editor.contains(o)&&(i=o);if(t.editor==i){i=t.editor.one(":first-child");if(!i)return}if(t.editor==s){s=t.editor.one(":last-child");if(!s)return}if(!t.editor.contains(i))return;if(!t.editor.contains(s))return;this._currentSelection[0].setStartBefore(i.getDOMNode()),this._currentSelection[0].setEndAfter(s.getDOMNode());var u=this._currentSelection[0].extractContents(),a=e.Node.create("<blockquote></blockquote>"),f=t.insertContentAtFocusPoint(a.get("outerHTML"));f.getDOMNode().appendChild(u),window.rangy.getSelection().collapse(n,r),t.editor.all("blockquote").each(function(e){this._containsText(e)||e.remove()},this)},_setupKeyListener:function(){this.editor.on("key",function(t){if(t.shiftKey)return;var n=this.get("host");this._currentSelection=n.getSelection();var r=this.get("host").getSelectionParentNode();if(this.editor==r)return;var i=e.one(this._currentSelection[0].startContainer);i.get("nodeName")!="BLOCKQUOTE"&&(i=i.ancestor("blockquote"));if(!i)return;t.preventDefault();var s=e.Node.create("<span></span>");s.addClass("splitmarker"),n.insertContentAtFocusPoint(s.get("outerHTML"));var o=i.cloneNode(!0),u=o.one("span.splitmarker");while(u!=o){var a=u.getDOMNode().previousSibling;while(a)a.parentNode.removeChild(a),a=u.getDOMNode().previousSibling;u=u.ancestor()}u=i.one("span.splitmarker");while(u!=i){var f=u.getDOMNode().nextSibling;while(f)f.parentNode.removeChild(f),f=u.getDOMNode().nextSibling;u=u.ancestor()}i.one("span.splitmarker").remove(),o.one("span.splitmarker").remove();var l=e.Node.create("<p>&nbsp;</p>");i.insert(l,"after"),l.insert(o,"after");var c=n.getSelectionFromNode(l);c[0].collapse(!0),n.setSelection(c),l.focus(),this._containsText(i)||i.remove(),this._containsText(o)||o.remove()},"enter",this)},_containsText:function(e){if(!e.hasChildNodes()){if(e.get("nodeName")!="#text")return!1;var t=e.get("nodeValue");return t?(t=t.trim(),t.length>0):!1}var n=!1;return e.get("childNodes").each(function(e){this._containsText(e)&&(n=!0)},this),n}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
