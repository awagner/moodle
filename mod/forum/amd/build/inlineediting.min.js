define(["jquery","core/ajax","core/notification","core/str"],function(a,b,c,d){function e(){var d=a('#forum-inlineform input[name="reply"]').val(),e=a("#forum-inlineform #id_subject").val(),f=a("#forum-inlineform #id_messageeditable").html();a("#forum-inlineform #id_message").html(f),b.call([{methodname:"mod_forum_add_discussion_post",args:{postid:d,subject:e,message:f,options:[{name:"inlineattachmentsid",value:x}]},done:h,fail:c.exception}])}function f(){var d=a('#forum-inlineform input[name="edit"]').val(),e=a("#forum-inlineform #id_subject").val(),f=a("#forum-inlineform #id_messageeditable").html(),g=[{name:"inlineattachmentsid",value:x}],i=a("#forum-inlineform #id_pinned").val();i&&g.push({name:"pinned",value:i}),a("#forum-inlineform #id_message").html(f),b.call([{methodname:"mod_forum_update_discussion_post",args:{postid:d,subject:e,message:f,options:g},done:h,fail:c.exception}])}function g(){"reply"===y&&e(),"edit"===y&&f()}function h(d){var e=d.postid;b.call([{methodname:"mod_forum_render_forum_discussion",args:{postid:d.postid},done:function(b){if(1==b.status){p(),s.html(b.html);var c=a("#p"+e),d=a(window);c.offset().top>d.scrollTop()+d.height()&&a("html, body").animate({scrollTop:c.offset().top-c.outerHeight()},1e3)}},fail:c.exception}])}function i(){var b=a("#forum-inlineform #id_messageeditable");b.focus();var c=document.createRange();c.selectNodeContents(b[0]),c.collapse(!1);var d=window.getSelection();d.removeAllRanges(),d.addRange(c)}function j(b,c){var e=Number(b.attr("id").split("-")[2]);a('#forum-inlineform input[name="reply"]').val(e);var f=a("#forum-inlineform-authorpicture").html();r.find(".picture").html(f);var g=a("#forum-inlineform-authorname").html();r.find("#forum-inlineform #id_author").html(g),r.addClass("indent"),t&&t.removeClass("forum-link-disable"),t=b,t.addClass("forum-link-disable"),y="reply";var h=M.cfg.wwwroot+"/mod/forum/post.php?reply="+e;c&&(h+="&quote=1"),d.get_string("morereplyingoptions","forum").done(function(b){a("#id_morereplyingoptions").html(b)}),a("#id_morereplyingoptions").attr("href",h),a("#forum-inlineform-container-"+e).append(r),a("#forum-inlineform-container-"+e).hasClass("forum-post-hasparent")?a("#forum-inlineform #id_pinned").parentsUntil(".form-group").hide():a("#forum-inlineform #id_pinned").parentsUntil(".form-group").show(),i()}function k(b){w=Number(b.attr("id").split("-")[2]);var c=a("#p"+w+" div.forumpost:first div.subject").html();d.get_string("re","forum").done(function(b){a("#id_subject").val(b+" "+c)}),a("#forum-inlineform #id_messageeditable").html(""),j(b)}function l(b){a('#forum-inlineform input[name="edit"]').val(w);var c=a("#p"+w+" div.forumpost:first .picture").html();r.find(".picture").html(c);var e=a("#p"+w+" div.forumpost:first .author").html();r.find("#forum-inlineform #id_author").html(e),r.removeClass("indent"),t&&t.removeClass("forum-link-disable"),t=b,t.addClass("forum-link-disable"),y="edit";var f=M.cfg.wwwroot+"/mod/forum/post.php?edit="+w;d.get_string("moreeditingoptions","forum").done(function(b){a("#id_morereplyingoptions").html(b)}),a("#id_morereplyingoptions").attr("href",f),a("#forum-inlineform-container-"+w).append(r),a("#forum-inlineform-container-"+w).hasClass("forum-post-hasparent")?a("#forum-inlineform #id_pinned").parentsUntil(".form-group").hide():a("#forum-inlineform #id_pinned").parentsUntil(".form-group").show(),a("#p"+w+" div.forumpost:first").hide()}function m(a,d){b.call([{methodname:"mod_forum_get_post_inline_editor",args:{postid:a,discussionid:v,draftideditor:x},done:d,fail:c.exception}])}function n(b){a("#p"+w+" div.forumpost:first div.subject").html(),d.get_string("re","forum").done(function(c){a("#id_subject").val(c+" "+b.post.subject)}),a("#p"+w+" div.forumpost:first div.content").html(),a("#id_messageeditable").html("<blockquote>"+b.currenttext+"</blockquote><br/>"),a("#forum-inlineform #id_message").html("<blockquote>"+b.currenttext+"</blockquote><br/>"),j(u,"quote")}function o(b){a("#id_subject").val(b.post.subject),a("#p"+w+" div.forumpost:first div.content").html(),a("#id_messageeditable").html(b.currenttext),a("#forum-inlineform #id_message").html(b.currenttext),l(u)}function p(){w>0&&a("#p"+w+" div.forumpost:first").show(),q.append(r),a("#forum-inlineform #id_subject").val(""),a("#forum-inlineform #id_messageeditable").html(""),r.removeClass("indent"),t.removeClass("forum-link-disable"),t=null,y="",w=0}var q=null,r=null,s=null,t=null,u=null,v=0,w=0,x=0,y="";return{init:function(b){v=b.discussionid;var c=b.sesskey;x=a('input[name="message[itemid]"').val(),q=a("#forum-inlineform-container"),r=a("#forum-inlineform-wrapper"),s=a("#forum-discussion-container");var d=a("#page-mod-forum-discuss #region-main");d.on("click",'a[id^="forum-reply-"]',function(b){b.preventDefault(),u=a(this),u.hasClass("forum-link-disable")||k(a(this))}),d.on("click",'a[id^="forum-quote-"]',function(b){b.preventDefault(),u=a(this),u.hasClass("forum-link-disable")||(w=Number(u.attr("id").split("-")[2]),m(w,n))}),d.on("click",'a[id^="forum-edit-"]',function(b){b.preventDefault(),u=a(this),u.hasClass("forum-link-disable")||(w=Number(u.attr("id").split("-")[2]),m(w,o))}),r.on("submit",function(b){return b.preventDefault(),g(a(this))}),a("#forum-inlineform #id_cancel").on("click",function(a){a.preventDefault(),p()}),a("#id_morereplyingoptions").on("click",function(){var b=a(this).attr("href"),d=a("#forum-inlineform #id_messageeditable").html(),e=a("#forum-inlineform #id_subject").val();b+="&message[itemid]="+x+"&sesskey="+c+"&inlinemessage="+d+"&inlinesubject="+e,a(this).attr("href",encodeURI(b))})}}});